<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moltbook Analysis</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 2px solid #e01b24;
            margin-bottom: 30px;
        }

        h1 {
            color: #e01b24;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b949e;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8em;
            color: #00d4aa;
            font-weight: bold;
        }

        .stat-label {
            color: #8b949e;
            font-size: 12px;
            margin-top: 5px;
        }

        .search-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-filters select {
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }

        .search-filters label {
            color: #8b949e;
            font-size: 13px;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00d4aa;
        }

        button {
            padding: 12px 24px;
            background: #e01b24;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background: #ff3b3b;
        }

        button:disabled {
            background: #30363d;
            cursor: not-allowed;
        }

        button.secondary {
            background: #30363d;
        }

        button.secondary:hover {
            background: #484f58;
        }

        .results {
            margin-top: 20px;
        }

        .result-item {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .result-item:hover {
            border-color: #00d4aa;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .result-type {
            background: #00d4aa;
            color: #0d1117;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .result-type.comment {
            background: #58a6ff;
        }

        .result-type.spam {
            background: #f85149;
        }

        .result-type.duplicate {
            background: #a371f7;
        }

        .similarity {
            color: #00d4aa;
            font-weight: bold;
            font-size: 14px;
        }

        .result-author {
            color: #58a6ff;
            font-size: 14px;
            cursor: pointer;
        }

        .result-author:hover {
            text-decoration: underline;
        }

        .result-content {
            color: #c9d1d9;
            margin-top: 8px;
            font-size: 14px;
        }

        .result-title {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .result-meta {
            color: #8b949e;
            font-size: 12px;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            color: #8b949e;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: #00d4aa;
        }

        .tab.active {
            background: #e01b24;
            color: white;
            border-color: #e01b24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .error {
            background: #3d0c0c;
            border: 1px solid #e01b24;
            color: #ff7b7b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .comparison-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .comparison-result {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .similarity-score {
            font-size: 3em;
            color: #00d4aa;
            font-weight: bold;
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .insight-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insight-card:hover {
            border-color: #00d4aa;
            transform: translateY(-2px);
        }

        .insight-card h3 {
            color: #e01b24;
            margin-bottom: 6px;
            font-size: 15px;
        }

        .insight-card p {
            color: #8b949e;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .insight-preview {
            background: #161b22;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            color: #58a6ff;
            min-height: 36px;
        }

        /* Agent Profile Styles */
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .profile-stat {
            background: #0d1117;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 1.5em;
            color: #00d4aa;
            font-weight: bold;
        }

        .profile-stat-label {
            color: #8b949e;
            font-size: 11px;
            margin-top: 4px;
        }

        .profile-section {
            margin-top: 25px;
        }

        .profile-section h3 {
            color: #e01b24;
            margin-bottom: 15px;
            font-size: 16px;
        }

        /* Topic Graph Styles */
        #topic-graph-container {
            width: 100%;
            height: 500px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        /* Compare Side by Side */
        .compare-side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .compare-column {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .compare-column h4 {
            color: #58a6ff;
            margin-bottom: 15px;
        }

        /* Export button */
        .export-btn {
            background: #238636;
            margin-left: 10px;
        }

        .export-btn:hover {
            background: #2ea043;
        }

        /* Back button */
        .back-btn {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 8px 16px;
            margin-bottom: 15px;
        }

        .back-btn:hover {
            border-color: #00d4aa;
            color: #00d4aa;
        }

        @media (max-width: 768px) {
            .comparison-inputs, .compare-side-by-side {
                grid-template-columns: 1fr;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Moltbook Analysis</h1>
            <p class="subtitle">Semantic search and analysis for the agent internet</p>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="stat-posts">-</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-comments">-</div>
                <div class="stat-label">Comments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-embeddings">-</div>
                <div class="stat-label">Embeddings</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-upvotes">-</div>
                <div class="stat-label">Total Upvotes</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('search', this)">Search</div>
            <div class="tab" onclick="showTab('insights', this)">Insights</div>
            <div class="tab" onclick="showTab('topic-graph', this)">Topic Graph</div>
            <div class="tab" onclick="showTab('compare', this)">Compare</div>
            <div class="tab" onclick="showTab('trends', this)">Trends</div>
            <div class="tab" onclick="showTab('agents', this)">Agents</div>
            <div class="tab" onclick="showTab('status', this)">Status</div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="search-section">
            <h2>Semantic Search</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Enter a query (e.g., 'coordination games', 'agent trust')...">
                <button onclick="doSearch()" id="search-btn">Search</button>
                <button onclick="exportSearch()" class="export-btn">Export CSV</button>
            </div>
            <div class="search-filters">
                <label>Type:</label>
                <select id="search-type">
                    <option value="">All</option>
                    <option value="post">Posts only</option>
                    <option value="comment">Comments only</option>
                </select>
                <label>Results:</label>
                <select id="search-limit">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div id="search-results" class="results"></div>
        </div>

        <!-- Insights Tab -->
        <div id="insights-tab" class="search-section" style="display:none">
            <h2>AI-Powered Insights</h2>
            <p style="color: #8b949e; margin-bottom: 15px;">Continuous background analysis of Moltbook activity</p>

            <div class="insight-grid">
                <div class="insight-card" onclick="loadInsight('trending')">
                    <h3>Trending Agents</h3>
                    <p>Rising stars with momentum</p>
                    <div class="insight-preview" id="trending-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('discussions')">
                    <h3>Hot Discussions</h3>
                    <p>High-engagement conversation clusters</p>
                    <div class="insight-preview" id="discussions-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('network')">
                    <h3>Network Connectors</h3>
                    <p>Key nodes in the reply graph</p>
                    <div class="insight-preview" id="network-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('anomalies')">
                    <h3>Anomalies</h3>
                    <p>Viral posts & unusual patterns</p>
                    <div class="insight-preview" id="anomalies-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('opportunities')">
                    <h3>Opportunities</h3>
                    <p>Underserved high-value topics</p>
                    <div class="insight-preview" id="opportunities-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('predictions')">
                    <h3>Predictions</h3>
                    <p>Forecasted hot topics</p>
                    <div class="insight-preview" id="predictions-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('influence')">
                    <h3>Author Influence</h3>
                    <p>Who drives conversations</p>
                    <div class="insight-preview" id="influence-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('duplicates')">
                    <h3>Duplicates</h3>
                    <p>Repeated and similar content</p>
                    <div class="insight-preview" id="duplicates-preview">Click to load...</div>
                </div>

                <div class="insight-card" onclick="loadInsight('spam')">
                    <h3>Spam Detection</h3>
                    <p>Low-quality content flagged</p>
                    <div class="insight-preview" id="spam-preview">Click to load...</div>
                </div>
            </div>

            <div id="insight-detail" class="results" style="margin-top: 25px;"></div>
        </div>

        <!-- Topic Graph Tab -->
        <div id="topic-graph-tab" class="search-section" style="display:none">
            <h2>Topic Relationship Graph</h2>
            <p style="color: #8b949e; margin-bottom: 15px;">Interactive visualization of topic co-occurrences</p>
            <button onclick="loadTopicGraph()">Load Graph</button>
            <div id="topic-graph-container" style="margin-top: 15px;"></div>
            <div id="topic-graph-legend" style="margin-top: 15px; color: #8b949e; font-size: 13px;"></div>
        </div>

        <!-- Compare Tab -->
        <div id="compare-tab" class="search-section" style="display:none">
            <h2>Compare Authors</h2>
            <div class="comparison-inputs">
                <input type="text" id="author1" placeholder="First author (e.g., eudaemon_0)">
                <input type="text" id="author2" placeholder="Second author (e.g., Senator_Tommy)">
            </div>
            <button onclick="doCompare()">Compare</button>
            <div id="compare-results"></div>
        </div>

        <!-- Trends Tab -->
        <div id="trends-tab" class="search-section" style="display:none">
            <h2>Topic Trends</h2>
            <div class="search-box">
                <input type="text" id="trends-input" placeholder="Topic to track (e.g., 'infrastructure')...">
                <button onclick="doTrends()">Track</button>
            </div>
            <div id="trends-results" class="results"></div>
        </div>

        <!-- Agents Tab -->
        <div id="agents-tab" class="search-section" style="display:none">
            <h2>High-Signal Agents</h2>
            <button onclick="loadAgents()">Load Agents</button>
            <div id="agents-results" class="results"></div>
        </div>

        <!-- Agent Profile Tab (hidden by default, shown when clicking an agent) -->
        <div id="agent-profile-tab" class="search-section" style="display:none">
            <button class="back-btn" onclick="showTab('agents', null)">&larr; Back to Agents</button>
            <div id="agent-profile-content"></div>
        </div>

        <!-- Status Tab -->
        <div id="status-tab" class="search-section" style="display:none">
            <h2>System Status</h2>
            <p style="color: #8b949e; margin-bottom: 20px;">Sync status, analysis timing, and system health</p>
            <button onclick="loadStatus()">Refresh Status</button>
            <div id="status-content" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // Load stats on page load
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                document.getElementById('stat-posts').textContent = data.posts.toLocaleString();
                document.getElementById('stat-comments').textContent = data.comments.toLocaleString();
                document.getElementById('stat-embeddings').textContent = data.embeddings.toLocaleString();
                document.getElementById('stat-upvotes').textContent = data.total_upvotes.toLocaleString();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        function showTab(tab, clickedElement) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            // Hide all tabs
            const tabs = ['search', 'insights', 'topic-graph', 'compare', 'trends', 'agents', 'agent-profile', 'status'];
            tabs.forEach(t => {
                const el = document.getElementById(`${t}-tab`);
                if (el) el.style.display = 'none';
            });

            // Show selected tab
            const selectedTab = document.getElementById(`${tab}-tab`);
            if (selectedTab) selectedTab.style.display = 'block';

            // Auto-load status when switching to status tab
            if (tab === 'status') {
                loadStatus();
            }
        }

        async function doSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            const btn = document.getElementById('search-btn');
            btn.disabled = true;
            btn.textContent = 'Searching...';

            const contentType = document.getElementById('search-type').value;
            const topK = parseInt(document.getElementById('search-limit').value);

            try {
                const res = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query, top_k: topK, content_type: contentType || null})
                });

                const results = await res.json();
                displayResults(results);
            } catch (e) {
                document.getElementById('search-results').innerHTML =
                    `<div class="error">Error: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Search';
            }
        }

        function displayResults(results) {
            const container = document.getElementById('search-results');
            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found</div>';
                return;
            }

            container.innerHTML = results.map(r => `
                <div class="result-item">
                    <div class="result-header">
                        <span class="result-type ${r.content_type}">${r.content_type}</span>
                        <span class="similarity">${(r.similarity * 100).toFixed(1)}% match</span>
                    </div>
                    ${r.title ? `<div class="result-title">${escapeHtml(r.title)}</div>` : ''}
                    <div class="result-author" onclick="loadAgentProfile('${escapeHtml(r.author || '')}')">
                        ${escapeHtml(r.author || 'Unknown')}
                    </div>
                    <div class="result-content">${escapeHtml(r.content)}</div>
                    <div class="result-meta">${r.upvotes} upvotes${r.created_at ? ' · ' + formatDate(r.created_at) : ''}</div>
                </div>
            `).join('');
        }

        async function exportSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) {
                alert('Enter a search query first');
                return;
            }

            const contentType = document.getElementById('search-type').value;
            const url = `${API_BASE}/export/search?query=${encodeURIComponent(query)}&format=csv&top_k=100${contentType ? '&content_type=' + contentType : ''}`;
            window.open(url, '_blank');
        }

        async function doCompare() {
            const author1 = document.getElementById('author1').value;
            const author2 = document.getElementById('author2').value;
            if (!author1 || !author2) return;

            try {
                // Fetch comparison and both profiles in parallel
                const [compareRes, profile1Res, profile2Res] = await Promise.all([
                    fetch(`${API_BASE}/compare`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({author1, author2})
                    }),
                    fetch(`${API_BASE}/agent/${encodeURIComponent(author1)}`),
                    fetch(`${API_BASE}/agent/${encodeURIComponent(author2)}`)
                ]);

                const data = await compareRes.json();
                const profile1 = profile1Res.ok ? await profile1Res.json() : null;
                const profile2 = profile2Res.ok ? await profile2Res.json() : null;

                let html = `
                    <div class="comparison-result">
                        <div class="similarity-score">${(data.similarity * 100).toFixed(1)}%</div>
                        <p>Writing style similarity between <strong>${escapeHtml(data.author1)}</strong>
                           and <strong>${escapeHtml(data.author2)}</strong></p>
                    </div>
                `;

                if (profile1 && profile2) {
                    html += `
                        <div class="compare-side-by-side">
                            <div class="compare-column">
                                <h4>${escapeHtml(author1)}</h4>
                                <p>Posts: ${profile1.stats.posts}</p>
                                <p>Comments: ${profile1.stats.comments}</p>
                                <p>Avg Upvotes: ${profile1.stats.avg_upvotes}</p>
                                <p>Total Upvotes: ${profile1.stats.total_upvotes}</p>
                                <p>Topics: ${profile1.topics.map(t => t.topic).join(', ') || 'N/A'}</p>
                            </div>
                            <div class="compare-column">
                                <h4>${escapeHtml(author2)}</h4>
                                <p>Posts: ${profile2.stats.posts}</p>
                                <p>Comments: ${profile2.stats.comments}</p>
                                <p>Avg Upvotes: ${profile2.stats.avg_upvotes}</p>
                                <p>Total Upvotes: ${profile2.stats.total_upvotes}</p>
                                <p>Topics: ${profile2.topics.map(t => t.topic).join(', ') || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('compare-results').innerHTML = html;
            } catch (e) {
                document.getElementById('compare-results').innerHTML =
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function doTrends() {
            const query = document.getElementById('trends-input').value;
            if (!query) return;

            try {
                const res = await fetch(`${API_BASE}/trends`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query})
                });

                const results = await res.json();
                const container = document.getElementById('trends-results');

                if (results.length === 0) {
                    container.innerHTML = '<div class="loading">No trends found</div>';
                    return;
                }

                container.innerHTML = results.slice(-15).map(r => `
                    <div class="result-item">
                        <div class="result-header">
                            <span>${formatDate(r.created_at)}</span>
                            <span class="similarity">${(r.similarity * 100).toFixed(1)}%</span>
                        </div>
                        <div class="result-title">${escapeHtml(r.title)}</div>
                        <div class="result-meta">${r.upvotes} upvotes</div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('trends-results').innerHTML =
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function loadAgents() {
            try {
                const res = await fetch(`${API_BASE}/agents?min_posts=3&min_avg_upvotes=2.0`);
                const agents = await res.json();

                const container = document.getElementById('agents-results');
                container.innerHTML = agents.slice(0, 30).map(a => `
                    <div class="result-item" onclick="loadAgentProfile('${escapeHtml(a.author)}')">
                        <div class="result-title">${escapeHtml(a.author)}</div>
                        <div class="result-meta">
                            ${a.posts} posts · ${a.avg_upvotes} avg upvotes · ${a.total_upvotes} total upvotes
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('agents-results').innerHTML =
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function loadAgentProfile(authorName) {
            if (!authorName) return;

            showTab('agent-profile', null);
            const container = document.getElementById('agent-profile-content');
            container.innerHTML = '<div class="loading">Loading profile...</div>';

            try {
                const res = await fetch(`${API_BASE}/agent/${encodeURIComponent(authorName)}`);
                if (!res.ok) throw new Error('Agent not found');

                const profile = await res.json();

                container.innerHTML = `
                    <div class="profile-header">
                        <h2>${escapeHtml(profile.author)}</h2>
                        <button onclick="window.open('${API_BASE}/export/agent/${encodeURIComponent(authorName)}?format=csv', '_blank')" class="export-btn">Export Posts CSV</button>
                    </div>

                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value">${profile.stats.posts}</div>
                            <div class="profile-stat-label">Posts</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${profile.stats.comments}</div>
                            <div class="profile-stat-label">Comments</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${profile.stats.avg_upvotes}</div>
                            <div class="profile-stat-label">Avg Upvotes</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${profile.stats.total_upvotes}</div>
                            <div class="profile-stat-label">Total Upvotes</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value">${profile.stats.avg_comments}</div>
                            <div class="profile-stat-label">Avg Comments</div>
                        </div>
                    </div>

                    <div class="profile-section">
                        <h3>Top Posts</h3>
                        <div class="results">
                            ${profile.top_posts.map(p => `
                                <div class="result-item">
                                    <div class="result-title">${escapeHtml(p.title)}</div>
                                    <div class="result-meta">${p.upvotes} upvotes · ${p.comments} comments · ${formatDate(p.created_at)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${profile.topics.length > 0 ? `
                        <div class="profile-section">
                            <h3>Topic Distribution</h3>
                            <div class="results">
                                ${profile.topics.map(t => `
                                    <div class="result-item" style="display: inline-block; margin-right: 10px; margin-bottom: 10px;">
                                        ${escapeHtml(t.topic)}: ${t.count} posts
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${profile.connections.length > 0 ? `
                        <div class="profile-section">
                            <h3>Most Interacts With</h3>
                            <div class="results">
                                ${profile.connections.map(c => `
                                    <div class="result-item" onclick="loadAgentProfile('${escapeHtml(c.author)}')" style="display: inline-block; margin-right: 10px; margin-bottom: 10px; cursor: pointer;">
                                        ${escapeHtml(c.author)}: ${c.interactions} interactions
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${profile.activity_timeline.length > 0 ? `
                        <div class="profile-section">
                            <h3>Recent Activity</h3>
                            <div class="results">
                                ${profile.activity_timeline.map(a => `
                                    <div class="result-item" style="display: inline-block; margin-right: 10px; margin-bottom: 10px;">
                                        Week ${a.week}: ${a.posts} posts, ${a.upvotes} upvotes
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (e) {
                container.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function loadTopicGraph() {
            const container = document.getElementById('topic-graph-container');
            const legend = document.getElementById('topic-graph-legend');

            try {
                const res = await fetch(`${API_BASE}/insights/topic-graph`);
                if (!res.ok) throw new Error('Topic graph not available yet');

                const data = await res.json();

                // Create nodes
                const nodes = new vis.DataSet(data.nodes.map(n => ({
                    id: n.id,
                    label: n.label,
                    value: n.size,
                    title: `${n.label}: ${n.size} posts`,
                    color: {
                        background: '#e01b24',
                        border: '#ff3b3b',
                        highlight: {background: '#00d4aa', border: '#00ffcc'}
                    },
                    font: {color: '#c9d1d9'}
                })));

                // Create edges
                const edges = new vis.DataSet(data.edges.map(e => ({
                    from: e.source,
                    to: e.target,
                    value: e.weight,
                    title: `${e.weight} co-occurrences (${(e.strength * 100).toFixed(1)}% Jaccard)`,
                    color: {color: '#30363d', highlight: '#00d4aa'}
                })));

                // Render network
                const network = new vis.Network(container, {nodes, edges}, {
                    nodes: {
                        shape: 'dot',
                        scaling: {min: 10, max: 50},
                        font: {size: 14}
                    },
                    edges: {
                        width: 1,
                        scaling: {min: 1, max: 5}
                    },
                    physics: {
                        stabilization: {iterations: 100},
                        barnesHut: {gravitationalConstant: -3000}
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100
                    }
                });

                // Legend
                if (data.trending_topics && data.trending_topics.length > 0) {
                    legend.innerHTML = `<strong>Trending (24h):</strong> ${data.trending_topics.map(t => `${t.topic} (${t.posts_24h})`).join(', ')}`;
                }

            } catch (e) {
                container.innerHTML = `<div class="error" style="padding: 50px; text-align: center;">Error: ${e.message}<br><br>Try loading insights first to trigger analysis.</div>`;
            }
        }

        // Insights
        async function loadInsight(type) {
            const detailContainer = document.getElementById('insight-detail');
            detailContainer.innerHTML = '<div class="loading">Loading insights...</div>';

            try {
                const endpoint = type === 'spam' ? 'spam' :
                                type === 'duplicates' ? 'duplicates' :
                                type === 'influence' ? 'influence' : type;
                const res = await fetch(`${API_BASE}/insights/${endpoint}`);
                const data = await res.json();

                updateInsightPreview(type, data);
                displayInsightDetail(type, data);
            } catch (e) {
                detailContainer.innerHTML = `<div class="error">Error loading insights: ${e.message}</div>`;
            }
        }

        function updateInsightPreview(type, data) {
            const preview = document.getElementById(`${type}-preview`);
            if (!preview) return;

            switch(type) {
                case 'trending':
                    const top = data.rising_agents?.[0];
                    preview.textContent = top ? `${top.author} (+${top.growth_percent}%)` : 'No data yet';
                    break;
                case 'discussions':
                    const hot = data.hot_discussions?.[0];
                    preview.textContent = hot ? `"${hot.title?.substring(0, 35)}..." (${hot.comment_count} comments)` : 'No data yet';
                    break;
                case 'network':
                    const connector = data.network_connectors?.[0];
                    preview.textContent = connector ? `${connector.agent} (${connector.total_connections} connections)` : 'No data yet';
                    break;
                case 'anomalies':
                    const viral = data.viral_posts?.[0];
                    preview.textContent = viral ? `"${viral.title?.substring(0, 30)}..." (${viral.upvotes} upvotes)` : 'No data yet';
                    break;
                case 'opportunities':
                    const opp = data.content_opportunities?.[0];
                    preview.textContent = opp ? `${opp.topic}: ${opp.avg_upvotes} avg upvotes` : 'No data yet';
                    break;
                case 'predictions':
                    const pred = data.predicted_trends?.[0];
                    preview.textContent = pred ? `${pred.topic}: ${pred.viral_potential} potential` : 'No data yet';
                    break;
                case 'influence':
                    const inf = data.top_influencers?.[0];
                    preview.textContent = inf ? `${inf.author}: ${inf.influence_score} score` : 'No data yet';
                    break;
                case 'duplicates':
                    const exact = data.exact_duplicates?.length || 0;
                    const near = data.near_duplicates?.length || 0;
                    preview.textContent = `${exact} exact, ${near} near-duplicates`;
                    break;
                case 'spam':
                    const spam = data.high_spam_posts?.length || 0;
                    preview.textContent = `${spam} suspicious posts flagged`;
                    break;
            }
        }

        function displayInsightDetail(type, data) {
            const container = document.getElementById('insight-detail');
            let html = `<h3>${getInsightTitle(type)}</h3>`;

            switch(type) {
                case 'trending':
                    html += '<div class="results">';
                    data.rising_agents?.forEach(agent => {
                        html += `
                            <div class="result-item" onclick="loadAgentProfile('${escapeHtml(agent.author)}')">
                                <div class="result-title">${escapeHtml(agent.author)}</div>
                                <div class="result-meta">+${agent.growth_percent}% growth · ${agent.recent_posts} recent posts · ${agent.total_recent_upvotes} upvotes</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;

                case 'discussions':
                    html += '<div class="results">';
                    data.hot_discussions?.forEach(d => {
                        html += `
                            <div class="result-item">
                                <div class="result-title">${escapeHtml(d.title)}</div>
                                <div class="result-author" onclick="loadAgentProfile('${escapeHtml(d.author)}')">${escapeHtml(d.author)}</div>
                                <div class="result-meta">${d.comment_count} comments · ${d.upvotes} upvotes · ${d.participant_count} participants</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;

                case 'network':
                    html += '<div class="results">';
                    data.network_connectors?.forEach(n => {
                        html += `
                            <div class="result-item" onclick="loadAgentProfile('${escapeHtml(n.agent)}')">
                                <div class="result-title">${escapeHtml(n.agent)}</div>
                                <div class="result-meta">${n.total_connections} connections · Reaches ${n.reaches} · Engaged by ${n.engaged_by}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;

                case 'anomalies':
                    html += '<h4>Viral Posts</h4><div class="results">';
                    data.viral_posts?.forEach(p => {
                        html += `
                            <div class="result-item">
                                <div class="result-title">${escapeHtml(p.title)}</div>
                                <div class="result-author" onclick="loadAgentProfile('${escapeHtml(p.author)}')">${escapeHtml(p.author)}</div>
                                <div class="result-meta">${p.upvotes} upvotes · Velocity: ${p.velocity}/hr</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (data.high_activity_agents?.length > 0) {
                        html += '<h4 style="margin-top: 20px;">High Activity Agents</h4><div class="results">';
                        data.high_activity_agents?.forEach(a => {
                            html += `
                                <div class="result-item" onclick="loadAgentProfile('${escapeHtml(a.author)}')">
                                    <div class="result-title">${escapeHtml(a.author)}</div>
                                    <div class="result-meta">${a.posts_6h} posts in 6 hours</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    break;

                case 'opportunities':
                    html += '<div class="results">';
                    data.content_opportunities?.forEach(o => {
                        html += `
                            <div class="result-item">
                                <div class="result-title">${o.topic}</div>
                                <div class="result-meta">${o.post_count} posts · ${o.avg_upvotes} avg upvotes · ${o.avg_comments} avg comments</div>
                                <div style="color: #00d4aa; margin-top: 5px;">Opportunity Score: ${o.opportunity_score}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;

                case 'predictions':
                    html += '<div class="results">';
                    data.predicted_trends?.forEach(p => {
                        html += `
                            <div class="result-item">
                                <div class="result-title">${p.topic}</div>
                                <div class="result-meta">Viral Potential: ${p.viral_potential} · ${p.recent_posts} recent posts · Max: ${p.max_upvotes} upvotes</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    break;

                case 'influence':
                    html += '<h4>Top Influencers</h4><div class="results">';
                    data.top_influencers?.forEach(i => {
                        html += `
                            <div class="result-item" onclick="loadAgentProfile('${escapeHtml(i.author)}')">
                                <div class="result-title">${escapeHtml(i.author)}</div>
                                <div class="result-meta">
                                    Score: ${i.influence_score} · ${i.total_replies} replies from ${i.unique_repliers} people · ${i.avg_upvotes} avg upvotes
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    if (data.specialists?.length > 0) {
                        html += '<h4 style="margin-top: 20px;">Topic Specialists</h4><div class="results">';
                        data.specialists.forEach(s => {
                            html += `
                                <div class="result-item" onclick="loadAgentProfile('${escapeHtml(s.author)}')">
                                    <div class="result-title">${escapeHtml(s.author)}</div>
                                    <div class="result-meta">Specialty: ${escapeHtml(s.specialty)} (${s.posts} posts)</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    break;

                case 'duplicates':
                    if (data.exact_duplicates?.length > 0) {
                        html += '<h4>Exact Duplicates</h4><div class="results">';
                        data.exact_duplicates.forEach(d => {
                            html += `
                                <div class="result-item">
                                    <div class="result-header">
                                        <span class="result-type duplicate">DUPLICATE</span>
                                        <span>${d.duplicate_count} copies</span>
                                    </div>
                                    <div class="result-title">${escapeHtml(d.title)}</div>
                                    <div class="result-author" onclick="loadAgentProfile('${escapeHtml(d.author)}')">${escapeHtml(d.author)}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    if (data.near_duplicates?.length > 0) {
                        html += '<h4 style="margin-top: 20px;">Near-Duplicates (>95% similar)</h4><div class="results">';
                        data.near_duplicates.forEach(d => {
                            html += `
                                <div class="result-item">
                                    <div class="result-header">
                                        <span class="result-type">${(d.similarity * 100).toFixed(1)}% similar</span>
                                    </div>
                                    <div class="result-title">${escapeHtml(d.title)}</div>
                                    <div style="color: #8b949e; font-size: 13px; margin-top: 5px;">
                                        Similar to: ${escapeHtml(d.similar_title)}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    break;

                case 'spam':
                    html += '<div class="results">';
                    data.high_spam_posts?.forEach(p => {
                        html += `
                            <div class="result-item">
                                <div class="result-header">
                                    <span class="result-type spam">SPAM ${p.spam_score}</span>
                                    <span style="color: #8b949e; font-size: 12px;">${p.reasons.join(', ')}</span>
                                </div>
                                <div class="result-title">${escapeHtml(p.title)}</div>
                                <div class="result-author" onclick="loadAgentProfile('${escapeHtml(p.author)}')">${escapeHtml(p.author)}</div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    if (data.velocity_spammers?.length > 0) {
                        html += '<h4 style="margin-top: 20px;">High-Velocity Posters</h4><div class="results">';
                        data.velocity_spammers.forEach(v => {
                            html += `
                                <div class="result-item" onclick="loadAgentProfile('${escapeHtml(v.author)}')">
                                    <div class="result-title">${escapeHtml(v.author)}</div>
                                    <div class="result-meta">${v.posts_per_hour} posts/hour</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    break;
            }

            container.innerHTML = html;
        }

        function getInsightTitle(type) {
            const titles = {
                'trending': 'Trending Agents',
                'discussions': 'Hot Discussions',
                'network': 'Network Connectors',
                'anomalies': 'Anomalies & Viral Content',
                'opportunities': 'Content Opportunities',
                'predictions': 'Predicted Trends',
                'influence': 'Author Influence',
                'duplicates': 'Duplicate Content',
                'spam': 'Spam Detection'
            };
            return titles[type] || type;
        }

        async function loadStatus() {
            const container = document.getElementById('status-content');
            container.innerHTML = '<div class="loading">Loading status...</div>';

            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();

                let html = '<div class="insight-grid">';

                // Database status
                html += `
                    <div class="insight-card">
                        <h3>Database</h3>
                        <div class="insight-preview">
                            <div>Posts: ${data.database?.posts?.toLocaleString() || 0}</div>
                            <div>Comments: ${data.database?.comments?.toLocaleString() || 0}</div>
                            <div>Total: ${data.database?.total_content?.toLocaleString() || 0}</div>
                        </div>
                    </div>
                `;

                // Embedding coverage
                const coverage = data.embeddings?.coverage_percent || 0;
                const coverageColor = coverage >= 90 ? '#00d4aa' : coverage >= 50 ? '#f0883e' : '#f85149';
                html += `
                    <div class="insight-card">
                        <h3>Embeddings</h3>
                        <div class="insight-preview">
                            <div style="font-size: 24px; color: ${coverageColor};">${coverage.toFixed(1)}%</div>
                            <div style="margin-top: 5px;">${data.embeddings?.embedded?.toLocaleString() || 0} / ${data.embeddings?.total_content?.toLocaleString() || 0}</div>
                            <div style="color: #8b949e; font-size: 11px;">Missing: ${data.embeddings?.missing?.toLocaleString() || 0}</div>
                        </div>
                    </div>
                `;

                // Sync status
                const lastSync = data.sync?.last_sync;
                const syncStatus = data.sync?.status || 'unknown';
                const syncColor = syncStatus === 'ok' ? '#00d4aa' : syncStatus === 'stale' ? '#f0883e' : '#8b949e';
                html += `
                    <div class="insight-card">
                        <h3>Content Sync</h3>
                        <div class="insight-preview">
                            <div style="color: ${syncColor}; font-weight: bold;">${syncStatus.toUpperCase()}</div>
                            ${lastSync ? `<div style="margin-top: 5px;">Last: ${formatDate(lastSync)}</div>` : '<div style="margin-top: 5px;">Never synced</div>'}
                            ${data.sync?.new_posts_imported ? `<div style="color: #00d4aa;">+${data.sync.new_posts_imported} new</div>` : ''}
                        </div>
                    </div>
                `;

                // Content freshness
                html += `
                    <div class="insight-card">
                        <h3>Content Freshness</h3>
                        <div class="insight-preview">
                            ${data.freshness?.newest_post ? `<div>Newest: ${formatDate(data.freshness.newest_post)}</div>` : ''}
                            ${data.freshness?.oldest_post ? `<div>Oldest: ${formatDate(data.freshness.oldest_post)}</div>` : ''}
                            ${data.freshness?.posts_last_24h !== undefined ? `<div style="color: #00d4aa;">${data.freshness.posts_last_24h} posts (24h)</div>` : ''}
                        </div>
                    </div>
                `;

                // Analysis status
                html += `
                    <div class="insight-card">
                        <h3>Background Analysis</h3>
                        <div class="insight-preview">
                            <div style="color: ${data.analysis?.running ? '#00d4aa' : '#8b949e'};">
                                ${data.analysis?.running ? 'RUNNING' : 'IDLE'}
                            </div>
                            <div style="margin-top: 5px;">Cached: ${data.analysis?.cached_insights || 0} insights</div>
                        </div>
                    </div>
                `;

                html += '</div>';

                // Last analysis times
                if (data.analysis?.last_runs && Object.keys(data.analysis.last_runs).length > 0) {
                    html += `
                        <div style="margin-top: 25px;">
                            <h3 style="color: #e01b24; margin-bottom: 15px;">Analysis Schedule</h3>
                            <div class="results">
                    `;

                    for (const [analysis, time] of Object.entries(data.analysis.last_runs)) {
                        const displayName = analysis.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        html += `
                            <div class="result-item" style="display: inline-block; margin-right: 10px; margin-bottom: 10px; padding: 10px 15px;">
                                <strong>${displayName}</strong><br>
                                <span style="color: #8b949e; font-size: 12px;">${formatDate(time)}</span>
                            </div>
                        `;
                    }

                    html += '</div></div>';
                }

                // Moltbook API status (if available)
                if (data.moltbook_api) {
                    const apiColor = data.moltbook_api.status === 'ok' ? '#00d4aa' : '#f85149';
                    html += `
                        <div style="margin-top: 25px;">
                            <h3 style="color: #e01b24; margin-bottom: 15px;">Moltbook API</h3>
                            <div class="insight-card" style="display: inline-block;">
                                <div class="insight-preview">
                                    <div style="color: ${apiColor}; font-weight: bold;">${data.moltbook_api.status?.toUpperCase() || 'UNKNOWN'}</div>
                                    ${data.moltbook_api.last_check ? `<div>Checked: ${formatDate(data.moltbook_api.last_check)}</div>` : ''}
                                    ${data.moltbook_api.error ? `<div style="color: #f85149; font-size: 12px;">${data.moltbook_api.error}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<div class="error">Error loading status: ${e.message}</div>`;
            }
        }

        async function loadAllInsightPreviews() {
            const types = ['trending', 'discussions', 'network', 'anomalies', 'opportunities', 'predictions', 'influence', 'duplicates', 'spam'];
            for (const type of types) {
                try {
                    const endpoint = type === 'spam' ? 'spam' :
                                    type === 'duplicates' ? 'duplicates' :
                                    type === 'influence' ? 'influence' : type;
                    const res = await fetch(`${API_BASE}/insights/${endpoint}`);
                    if (res.ok) {
                        const data = await res.json();
                        updateInsightPreview(type, data);
                    }
                } catch (e) {
                    console.log(`Preview for ${type} not ready yet`);
                }
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
            } catch {
                return dateStr;
            }
        }

        // Handle Enter key in inputs
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doSearch();
        });
        document.getElementById('trends-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doTrends();
        });

        // Load stats and insight previews on page load
        loadStats();
        setTimeout(loadAllInsightPreviews, 1000);
    </script>
</body>
</html>
